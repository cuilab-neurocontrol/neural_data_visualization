<!DOCTYPE html>
<meta charset="utf-8">

<!-- Load d3.js -->
<script src="https://d3js.org/d3.v6.js"></script>

<!-- Add a title for the control panel -->
<h2>Time Series Line Plot 1</h2>

<!-- Create a control panel -->
<div id="control-panel" style="display:none;">
  <!-- Subheading for Canvas Size -->
  <details>
    <summary>Canvas Size</summary>
    <div class="control-row">
      <label for="width">Width (cm):</label>
      <input type="number" id="width" value="8" min="5" step="0.0001" data-param="width">
      <label for="height">Height (cm):</label>
      <input type="number" id="height" value="8" min="5" step="0.0001" data-param="height">
    </div>
  </details>

  <!-- Subheading for Margins -->
  <details>
    <summary>Margins</summary>
    <div class="control-row">
      <label for="margin-top">Top (cm):</label>
      <input type="number" id="margin-top" value="2" min="0" step="0.0001">
      <label for="margin-right">Right (cm):</label>
      <input type="number" id="margin-right" value="2" min="0" step="0.0001">
    </div>
    <div class="control-row">
      <label for="margin-bottom">Bottom (cm):</label>
      <input type="number" id="margin-bottom" value="2" min="0" step="0.0001">
      <label for="margin-left">Left (cm):</label>
      <input type="number" id="margin-left" value="2" min="0" step="0.0001">
    </div>
  </details>

  <!-- Subheading for Axis Margins -->
  <details>
    <summary>Axis</summary>
    <div class="control-row">
      <label for="show-outer-ticks">Show Outer Ticks:</label>
      <input type="checkbox" id="show-outer-ticks" checked>
    </div>
    <div class="control-row">
      <label for="show-x-axis">Show X Axis:</label>
      <input type="checkbox" id="show-x-axis" checked>
      <label for="show-y-axis">Show Y Axis:</label>
      <input type="checkbox" id="show-y-axis" checked>
    </div>
    <div class="control-row">
      <label for="axis-margin-x">X Margin (cm):</label>
      <input type="number" id="axis-margin-x" value="0.3" min="0" step="0.0001">
      <label for="axis-margin-y">Y Margin (cm):</label>
      <input type="number" id="axis-margin-y" value="0" min="0" step="0.0001">
    </div>
    <!-- Subheading for Axis and Tick Styling -->
    <div class="control-row">
      <label for="axis-line-width">Line Width (px):</label>
      <input type="number" id="axis-line-width" value="2" min="1" step="0.1">
      <label for="tick-line-width">Tick Width (px):</label>
      <input type="number" id="tick-line-width" value="2" min="1" step="0.1">
    </div>
    <div class="control-row">
      <label for="tick-font-size">Font Size (px):</label>
      <input type="number" id="tick-font-size" value="18" min="1" step="1">
      <label for="tick-length">Tick Length (px):</label>
      <input type="number" id="tick-length" value="6" min="1" step="1">
    </div>
    <div class="control-row">
      <label for="tick-positions">xTick Positions:</label>
      <input type="text" id="x-tick-positions" value="0,10,20,30,40,50,60,70,80,90,100">
      <label for="tick-labels">xTick Labels:</label>
      <input type="text" id="x-tick-labels" value="0, ,20, , 40, ,60, ,80, ,100 ">
    </div>
    <div class="control-row">
      <label for="tick-positions">yTick Positions:</label>
      <input type="text" id="y-tick-positions" value="-2,0,2,4,6,8,10,12,14">
      <label for="tick-labels">yTick Labels:</label>
      <input type="text" id="y-tick-labels" value="-2, ,2, ,6, ,10, ,14">
    </div>
    <div class="control-row">
      <label for="tick-font-family">Tick Font Family:</label>
      <select id="tick-font-family">
        <option value="Arial">Arial</option>
        <option value="Courier New">Courier New</option>
        <option value="Times New Roman">Times New Roman</option>
        <option value="Verdana">Verdana</option>
      </select>
      <label for="tick-orientation">Tick Orientation:</label>
      <select id="tick-orientation">
        <option value="outward">Outward</option>
        <option value="inward">Inward</option>
      </select>
    </div>
    <div class="control-row">
      <label for="x-domain-min">X Domain Min:</label>
      <input type="number" id="x-domain-min" value="0" step="0.0001">
      <label for="x-domain-max">X Domain Max:</label>
      <input type="number" id="x-domain-max" value="100" step="0.0001">
    </div>
    <div class="control-row">
      <label for="y-domain-min">Y Domain Min:</label>
      <input type="number" id="y-domain-min" value="-2" step="0.0001">
      <label for="y-domain-max">Y Domain Max:</label>
      <input type="number" id="y-domain-max" value="16" step="0.0001">
    </div>
    <div class="control-row">
      <label for="x-label">X Axis Label:</label>
      <input type="text" id="x-label" value="Time from saccade onset (ms)">
      <label for="x-label-font-size">Font Size (px):</label>
      <input type="number" id="x-label-font-size" value="18" min="1" step="1">
    </div>
    <div class="control-row">
      <label for="x-label-font-family">X Font Family:</label>
      <select id="x-label-font-family">
        <option value="Arial">Arial</option>
        <option value="Courier New">Courier New</option>
        <option value="Times New Roman">Times New Roman</option>
        <option value="Verdana">Verdana</option>
      </select>
      <label for="show-x-label">Show X Label:</label>
      <input type="checkbox" id="show-x-label" checked>
    </div>
    <div class="control-row">
      <label for="y-label">Y Axis Label:</label>
      <input type="text" id="y-label" value="Firing Rate (Hz)">
      <label for="y-label-font-size">Font Size (px):</label>
      <input type="number" id="y-label-font-size" value="18" min="1" step="1">
    </div>
    <div class="control-row">
      <label for="y-label-font-family">Y Font Family:</label>
      <select id="y-label-font-family">
        <option value="Arial">Arial</option>
        <option value="Courier New">Courier New</option>
        <option value="Times New Roman">Times New Roman</option>
        <option value="Verdana">Verdana</option>
      </select>
      <label for="show-y-label">Show Y Label:</label>
      <input type="checkbox" id="show-y-label" checked>
    </div>
  </details>
  <!-- Subheading for Scale Bar Styling -->
  <details>
    <summary>Scale Bar Styling</summary>
    <div class="control-row">
      <label for="show-scale-bar">Show Scale Bar:</label>
      <input type="checkbox" id="show-scale-bar">
    </div>
    <div class="control-row">
      <label for="x-scale-bar-position-x">X Bar PosX (px):</label>
      <input type="number" id="x-scale-bar-position-x" value="0" min="0" step="1">
      <label for="x-scale-bar-position-y">X Bar PosY (px):</label>
      <input type="number" id="x-scale-bar-position-y" value="20" min="0" step="1">
      
    </div>
    <div class="control-row">
      <label for="x-scale-bar-width">X Bar Width (px):</label>
      <input type="number" id="x-scale-bar-width" value="2" min="1" step="0.1">
      <label for="x-scale-bar-length">X Bar Len (units):</label>
      <input type="number" id="x-scale-bar-length" value="100" min="1" step="0.0001">
    </div>
    <div class="control-row">
      <label for="x-scale-bar-label">X Bar Label:</label>
      <input type="text" id="x-scale-bar-label" value="100 units">
      <label for="x-scale-bar-label-orientation">X Orientation:</label>
      <select id="x-scale-bar-label-orientation">
        <option value="outward">Outward</option>
        <option value="inward">Inward</option>
      </select>
    </div>
    <div class="control-row">
      <label for="x-scale-bar-font-size">X Bar Font Size (px):</label>
      <input type="number" id="x-scale-bar-font-size" value="12" min="1" step="1">
      <label for="x-scale-bar-label-distance">X Label Distance (px):</label>
      <input type="number" id="x-scale-bar-label-distance" value="20" min="0" step="1">
    </div>
    <div class="control-row">
      <label for="x-scale-bar-font-family">X Bar Font Family:</label>
      <select id="x-scale-bar-font-family">
        <option value="Arial">Arial</option>
        <option value="Courier New">Courier New</option>
        <option value="Times New Roman">Times New Roman</option>
        <option value="Verdana">Verdana</option>
      </select>
    </div>

    <div class="control-row">
      <label for="y-scale-bar-position-x">Y Bar PosX (px):</label>
      <input type="number" id="y-scale-bar-position-x" value="20" min="0" step="1">
      <label for="y-scale-bar-position-y">Y Bar PosY (px):</label>
      <input type="number" id="y-scale-bar-position-y" value="20" min="0" step="1">
    </div>
    <div class="control-row">
      <label for="y-scale-bar-width">Y Bar Width (px):</label>
      <input type="number" id="y-scale-bar-width" value="2" min="1" step="0.1">
      <label for="y-scale-bar-length">Y Bar Len (units):</label>
      <input type="number" id="y-scale-bar-length" value="2" min="1" step="1">
    </div>
    <div class="control-row">
      <label for="y-scale-bar-label">Y Bar Label:</label>
      <input type="text" id="y-scale-bar-label" value="100 units">
      <label for="y-scale-bar-label-orientation">Y Orientation:</label>
      <select id="y-scale-bar-label-orientation">
        <option value="outward">Outward</option>
        <option value="inward">Inward</option>
      </select>
    </div>

    <div class="control-row">
      <label for="y-scale-bar-font-size">Y Bar Font Size (px):</label>
      <input type="number" id="y-scale-bar-font-size" value="12" min="1" step="1">
      <label for="y-scale-bar-label-distance">Y Label Distance (px):</label>
      <input type="number" id="y-scale-bar-label-distance" value="20" min="0" step="1">
    </div>
    <div class="control-row">
      <label for="y-scale-bar-font-family">Y Bar Font Family:</label>
      <select id="y-scale-bar-font-family">
        <option value="Arial">Arial</option>
        <option value="Courier New">Courier New</option>
        <option value="Times New Roman">Times New Roman</option>
        <option value="Verdana">Verdana</option>
      </select>
    </div>
  </details>
  <!-- Update Button -->
  <!-- Title Settings -->
  <details>
    <summary>Title Settings</summary>
    <div class="control-row">
      <label for="chart-title">Chart Title:</label>
      <input type="text" id="chart-title" value="simple spikes">
      <label for="show-title">Show Title:</label>
      <input type="checkbox" id="show-title" checked>
    </div>
    <div class="control-row">
      <label for="title-font-size">Font Size (px):</label>
      <input type="number" id="title-font-size" value="18" min="1" step="1">
      <label for="title-font-family">Font Family:</label>
      <select id="title-font-family">
        <option value="Arial">Arial</option>
        <option value="Courier New">Courier New</option>
        <option value="Times New Roman">Times New Roman</option>
        <option value="Verdana">Verdana</option>
      </select>
    </div>
    <div class="control-row">
      <label for="title-font-weight">Font Weight:</label>
      <select id="title-font-weight">
        <option value="normal">Normal</option>
        <option value="bold">Bold</option>
        <option value="bolder">Bolder</option>
        <option value="lighter">Lighter</option>
      </select>
      <label for="title-distance">Distance (pt):</label>
      <input type="number" id="title-distance" value="6" min="0" step="1">
    </div>
  </details>

  <!-- Data Series Upload -->
  <details>
    <summary>Data Series Upload</summary>
    <div class="control-row">
      <label for="data-files">Upload CSV Files:</label>
      <input type="file" id="data-files" multiple accept=".csv">
    </div>
    <div class="control-row">
      <label for="data-url">Or Data URL:</label>
      <input type="text" id="data-url" value=https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/data_IC.csv placeholder="Enter CSV URL">
      <button id="add-url">Add URL</button>
    </div>
    <!-- Container where each series control block will be appended -->
    <div id="series-controls"></div>
  </details>

  <!-- Line Settings -->
  <details>
    <summary>Line Settings</summary>
    <div class="control-row">
      <button id="add-line">Add Line</button>
    </div>
    <!-- 容器用于放置每个线的控制块 -->
    <div id="line-controls"></div>
  </details>

  <!-- Text Settings -->
  <details>
    <summary>Text Settings</summary>
    <div class="control-row">
      <button id="add-text">Add Text</button>
    </div>
    <!-- 容器用于放置每个文本控制块 -->
    <div id="text-controls"></div>
  </details>

  <!-- Area Settings -->
  <details>
    <summary>Area Settings</summary>
    <div class="control-row">
      <button id="add-area">Add Area</button>
    </div>
    <!-- 容器用于放置每个 Area 的控制块 -->
    <div id="area-controls"></div>
  </details>

  <div class="control-row">
    <button id="update" data-param="update">Update</button>
  </div>
</div>

<div style="margin:20px 0;">
  <button id="add-subplot">Add Subplot</button>
  <button id="export-svg">export to SVG</button>
  <button id="export-pdf" style="display:none;">export to PDF</button>
</div>
<div id="subplots-container">
  <!-- 控制面板区域 -->
  <div id="subplots-panel"></div>
  <div id="canvas-size-bar" style="margin-bottom:10px;">
    <label for="canvas-width-cm">Canvas width (cm):</label>
    <input type="number" id="canvas-width-cm" value="24" min="5" step="0.0001" style="width:70px;">
    <label for="canvas-height-cm" style="margin-left:10px;">Canvas height (cm):</label>
    <input type="number" id="canvas-height-cm" value="16" min="5" step="0.0001" style="width:70px;">
  </div>
  <!-- 在 #canvas-area 上方加 -->
  <div style="margin-bottom:10px;">
    <button id="add-canvas-text">Add text</button>
  </div>
  <!-- 画布区域 -->
  <div id="canvas-area">
    <div class="canvas-title">Canvas Area</div>
  </div>
  <div id="canvas-text-manager" style="margin-top:10px;"></div>
  <!-- 在 #canvas-text-manager 下面加 -->
  <div id="canvas-text-edit-panel" style="margin-top:16px;"></div>
</div>

<div id="conversion-calculator" style="margin-top: 10px; font-size: 0.9em; color: #555;">
  <h4>像素与厘米换算</h4>
  <div class="control-row">
    <label>像素 (px):</label>
    <input type="number" id="px-input" value="0" step="1">
    <label>厘米 (cm):</label>
    <input type="number" id="cm-output" value="0" step="0.01" readonly>
  </div>
  <div class="control-row">
    <label>厘米 (cm):</label>
    <input type="number" id="cm-input" value="0" step="0.01">
    <label>像素 (px):</label>
    <input type="number" id="px-output" value="0" step="1" readonly>
  </div>
</div>

<!-- Create a div where the graph will take place -->
<div id="my_dataviz" data-width="10" data-height="8"></div>

<!-- Add CSS for styling -->
<style>
  #control-panel {
    display: flex;
    flex-direction: column;
    gap: 15px; /* 增加子标题和内容之间的间距 */
    max-width: 400px; /* 原来是600px，改为400px更窄 */
    margin-bottom: 20px;
  }

  .control-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 10px; /* 增加元素之间的间距 */
    flex-wrap: nowrap; /* 禁止换行 */
  }

  .control-row label {
    flex: 0 0 90px; /* 原来是150px，改为90px更窄 */
    text-align: right;
    font-size: 0.95em;
  }

  .control-row input,
  .control-row select {
    flex: 1;
    max-width: 70px; /* 原来是100px，改为70px更窄 */
    font-size: 0.95em;
  }

  .control-row button {
    flex: 1;
    padding: 5px;
    max-width: 100px; /* 原来是150px，改为100px更窄 */
    font-size: 0.95em;
  }

  h3 {
    margin: 0;
    font-size: 1.2em;
    font-weight: bold;
  }

  .series-control {
    border: 1px solid #ccc;
    padding: 5px;
    margin: 10px 0;
  }

  .series-control h3 {
    margin: 0 0 5px 0;
    font-size: 1em;
  }

  #subplots-container {
    display: flex;
    flex-direction: column;
    position: relative;
    min-height: 800px;
  }

  #subplots-panel {
    margin-bottom: 20px;
  }

  #canvas-area {
    position: relative;
    width: 100%;
    min-width: 100px;
    min-height: 100px;
    background: #fff;
    border: 1px solid #ccc;
    margin: 20px 0;
    padding: 10px;
    resize: both;           /* 让画布可拖拽调整大小 */
    overflow: auto;
    box-sizing: border-box;
  }

  .canvas-title {
    position: absolute;
    top: -24px;
    left: 0;
    font-size: 0.9em;
    color: #666;
  }

  .subplot-instance {
    border: 1px solid #ccc;
    margin: 0 0 10px 0;
    padding: 10px;
    background: #fafbfc;
    position: static;
  }

  .subplot-chart {
    position: absolute;
    background: transparent;
    min-width: 320px;
    min-height: 240px;
    box-shadow: none;
    border: none;
    z-index: 1;
    cursor: move;
    /* 删除 left/top，由 JS 控制 */
  }

  /* 控制面板部分正常流式布局 */
  .subplot-controls {
    position: static;
    max-width: 650px;
    margin-bottom: 20px;
  }

  .subplot-controls {
    max-width: 650px;
    min-width: 0;
    width: 100%;
    margin-bottom: 20px;
  }

  .subplot-controls .control-row {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 8px;
    flex-wrap: nowrap;
  }

  .subplot-controls .control-row label {
    flex: 0 0 130px;
    max-width: 130px;
    font-size: 1em;
    text-align: right;
    margin-right: 6px;
  }

  .subplot-controls .control-row input,
  .subplot-controls .control-row select {
    flex: 1 1 120px;
    max-width: 180px;
    font-size: 1em;
    min-width: 0;
  }

  .subplot-controls .control-row button {
    flex: 1 1 120px;
    max-width: 180px;
    font-size: 1em;
    padding: 6px 12px;
  }

  .subplot-controls {
    margin-bottom: 20px;
  }

  .subplot-chart {
    min-height: 200px;
  }

  .canvas-text-label {
    position: absolute;
    background: none;
    border: none;
    padding: 0;
    margin: 0;
    border-radius: 0;
    min-width: 0;
    min-height: 0;
    max-width: none;
    word-break: break-all;
    z-index: 10;
    cursor: move;
    /* 只显示纯文字 */
  }
</style>

<script src="https://d3js.org/d3.v6.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://unpkg.com/svg2pdf.js@2.3.4/dist/svg2pdf.min.js"></script>
<script src="./chart.js"></script>
