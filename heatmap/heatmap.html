<!DOCTYPE html>
<meta charset="utf-8">
<script src="https://d3js.org/d3.v6.js"></script>

<body>
  <!-- 新增：CSV 文件上传控件 -->
  <div>
    <label>上传 CSV 文件：
      <input type="file" id="csv-file-input" accept=".csv">
    </label>
  </div>

  <div id="my_dataviz"></div>

  <script>
    const margin = {top: 30, right: 30, bottom: 30, left: 30},
          width  = 450 - margin.left - margin.right,
          height = 450 - margin.top  - margin.bottom;

    const svg = d3.select("#my_dataviz")
      .append("svg")
        .attr("width",  width  + margin.left + margin.right)
        .attr("height", height + margin.top  + margin.bottom)
      .append("g")
        .attr("transform", `translate(${margin.left},${margin.top})`);

    const myGroups = ["A","B","C","D","E","F","G","H"];
    const myVars   = ["v1","v2","v3","v4","v5","v6","v7","v8"];

    // X / Y 轴和颜色刻度：只需构造一次
    const x = d3.scaleBand().range([0, width]).domain(myGroups).padding(0.01);
    svg.append("g")
       .attr("transform", `translate(0, ${height})`)
       .attr("class","x-axis")
       .call(d3.axisBottom(x));

    const y = d3.scaleBand().range([height, 0]).domain(myVars).padding(0.01);
    svg.append("g")
       .attr("class","y-axis")
       .call(d3.axisLeft(y));

    const myColor = d3.scaleLinear()
      .range(["white","#69b3a2"])
      .domain([1,100]);

    // 绘图函数：接收 d3.csvParse 或 d3.csv 得到的数据数组
    function updateHeatmap(data) {
      // 先清掉旧的
      svg.selectAll("rect.heatcell").remove();

      svg.selectAll("rect.heatcell")
        .data(data, d => d.group+":"+d.variable)
        .join("rect")
          .attr("class","heatcell")
          .attr("x", d => x(d.group))
          .attr("y", d => y(d.variable))
          .attr("width",  x.bandwidth())
          .attr("height", y.bandwidth())
          .style("fill", d => myColor(d.value));
    }

    // 初始从远端加载
    d3.csv("https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/heatmap_data.csv")
      .then(updateHeatmap);

    // 监听本地上传
    document.getElementById("csv-file-input")
      .addEventListener("change", function(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = e => {
          const text = e.target.result;
          const data = d3.csvParse(text);
          updateHeatmap(data);
        };
        reader.readAsText(file);
      });
  </script>
</body>